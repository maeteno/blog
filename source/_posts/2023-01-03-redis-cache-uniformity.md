---
title: Redis 缓存不一致 - 延迟双删
tags:
  - Redis
categories: DB
date: 2023-01-03 20:54:34
---
# 概述
Redis 缓存不一致是指实际存储在数据库里的数据和缓存在Redis的数据不一致。而导致这个问题的根本原因是数据更新所导致的。只有数据发生了更新才有可能导致存储在两个位置（DB和Redis）的数据不一致。那么是不是只有我们在更新数据的时候，同时更新数据库和Redis就可以了呢？看似简单直接的方案往往藏了很多坑。因为这两个数据源的更新并不是原子性的，在并发情况下有诸多问题。为了简化对多数据源的管理，一般的方案都是选择更新数据库而选择让删除缓存使缓存失效。这样在获取数据的时候，会自动去数据库拉取最新的数据。
那么是不是我们只要选择更新数据，删除Redis缓存就可以实现缓存一致呢？

# 如何删除缓存
更新数据的时候使缓存失效，从而在需要数据的时候重新从数据库获取最新的数据，来刷新缓存达到缓存一致的目的。这个思路是对的。那么我们应该在什么时候去删除缓存呢？在更新数据库之前还是更新数据库数据之后呢？朴素的直觉告诉我们，肯定是在更新完数据库之后再来删除缓存即可。

## 更新后删除缓存
![延迟双删](/images/更新后删除缓存.svg)

## 并发更新下的脏数据
![更新后删除缓存极限情况下的脏数据](/images/更新后删除缓存极限情况下的脏数据.svg)

## 延迟删除

## 延迟双删
![延迟双删](/images/延迟双删.svg)

# 总结